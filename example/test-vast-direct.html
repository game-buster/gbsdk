<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct VAST Test - YouAdExchange</title>
    <style>
        body {
            font-family: monospace;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        h1 { color: #00ffff; }
        .section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #00ff00;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #00cc00; }
        .log {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 10px;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warn { color: #ffaa00; }
        .info { color: #00aaff; }
        input {
            width: 100%;
            padding: 10px;
            background: #000;
            border: 1px solid #00ff00;
            color: #00ff00;
            font-family: monospace;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üîç Direct VAST URL Test</h1>

    <div class="section">
        <h2>VAST URL to Test</h2>
        <input type="text" id="vastUrl" value="https://youradexchange.com/video/select.php?r=10633338">
        <button onclick="testVast()">Test VAST URL</button>
        <button onclick="testWithIMA()">Test with Google IMA</button>
    </div>

    <div class="section">
        <h2>VAST Response</h2>
        <div id="vastResponse" class="log">Click "Test VAST URL" to fetch VAST XML...</div>
    </div>

    <div class="section">
        <h2>IMA Test Log</h2>
        <div id="imaLog" class="log">Click "Test with Google IMA" to test ad playback...</div>
    </div>

    <!-- Google IMA SDK -->
    <script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>

    <script>
        async function testVast() {
            const url = document.getElementById('vastUrl').value;
            const logEl = document.getElementById('vastResponse');
            
            logEl.innerHTML = '<span class="info">Fetching VAST XML...</span>\n';
            logEl.innerHTML += '<span class="info">URL: ' + url + '</span>\n\n';

            try {
                const response = await fetch(url);
                const text = await response.text();
                
                logEl.innerHTML += '<span class="success">‚úÖ Response received!</span>\n';
                logEl.innerHTML += '<span class="info">Status: ' + response.status + '</span>\n';
                logEl.innerHTML += '<span class="info">Content-Type: ' + response.headers.get('content-type') + '</span>\n\n';
                logEl.innerHTML += '<span class="warn">VAST XML:</span>\n';
                logEl.innerHTML += text;

                // Parse and analyze
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, 'text/xml');
                const ads = xml.getElementsByTagName('Ad');
                
                logEl.innerHTML += '\n\n<span class="info">Analysis:</span>\n';
                logEl.innerHTML += '<span class="info">- VAST Version: ' + (xml.documentElement.getAttribute('version') || 'N/A') + '</span>\n';
                logEl.innerHTML += '<span class="info">- Number of Ads: ' + ads.length + '</span>\n';
                
                if (ads.length === 0) {
                    logEl.innerHTML += '<span class="error">‚ö†Ô∏è NO ADS FOUND - This is a "no fill" response</span>\n';
                    logEl.innerHTML += '<span class="warn">Possible reasons:</span>\n';
                    logEl.innerHTML += '<span class="warn">  1. Localhost not allowed by ad network</span>\n';
                    logEl.innerHTML += '<span class="warn">  2. Domain not approved</span>\n';
                    logEl.innerHTML += '<span class="warn">  3. No inventory available</span>\n';
                    logEl.innerHTML += '<span class="warn">  4. Geographic restrictions</span>\n';
                } else {
                    logEl.innerHTML += '<span class="success">‚úÖ ADS FOUND!</span>\n';
                    for (let i = 0; i < ads.length; i++) {
                        const ad = ads[i];
                        const mediaFiles = ad.getElementsByTagName('MediaFile');
                        logEl.innerHTML += '<span class="success">  Ad ' + (i+1) + ': ' + mediaFiles.length + ' media files</span>\n';
                    }
                }

            } catch (error) {
                logEl.innerHTML += '<span class="error">‚ùå Error: ' + error.message + '</span>\n';
            }
        }

        async function testWithIMA() {
            const url = document.getElementById('vastUrl').value;
            const logEl = document.getElementById('imaLog');
            
            logEl.innerHTML = '';
            
            function log(msg, type = 'info') {
                const span = document.createElement('div');
                span.className = type;
                span.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
                logEl.appendChild(span);
            }

            log('Testing with Google IMA SDK...', 'info');
            log('URL: ' + url, 'info');

            if (typeof google === 'undefined' || !google.ima) {
                log('ERROR: Google IMA SDK not loaded!', 'error');
                return;
            }

            try {
                // Create video element
                const video = document.createElement('video');
                video.style.display = 'none';
                document.body.appendChild(video);

                // Create ad container
                const adContainer = document.createElement('div');
                adContainer.style.position = 'fixed';
                adContainer.style.top = '50%';
                adContainer.style.left = '50%';
                adContainer.style.transform = 'translate(-50%, -50%)';
                adContainer.style.width = '640px';
                adContainer.style.height = '480px';
                adContainer.style.background = '#000';
                adContainer.style.zIndex = '10000';
                adContainer.style.border = '3px solid #00ff00';
                document.body.appendChild(adContainer);

                const adDisplayContainer = new google.ima.AdDisplayContainer(adContainer, video);
                adDisplayContainer.initialize();

                const adsLoader = new google.ima.AdsLoader(adDisplayContainer);

                adsLoader.addEventListener(
                    google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,
                    (event) => {
                        log('‚úÖ Ad loaded successfully!', 'success');
                        
                        const adsManager = event.getAdsManager(video);
                        
                        adsManager.addEventListener(google.ima.AdEvent.Type.STARTED, () => {
                            log('‚ñ∂Ô∏è Ad started playing', 'success');
                        });
                        
                        adsManager.addEventListener(google.ima.AdEvent.Type.COMPLETE, () => {
                            log('‚úÖ Ad completed', 'success');
                            cleanup();
                        });
                        
                        adsManager.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR, (e) => {
                            log(`‚ùå Ad playback error: ${e.getError().getMessage()}`, 'error');
                            cleanup();
                        });

                        try {
                            adsManager.init(640, 480, google.ima.ViewMode.NORMAL);
                            adsManager.start();
                            log('Ad manager started', 'info');
                        } catch (e) {
                            log(`‚ùå Error starting ad: ${e.message}`, 'error');
                            cleanup();
                        }
                    }
                );

                adsLoader.addEventListener(
                    google.ima.AdErrorEvent.Type.AD_ERROR,
                    (event) => {
                        const error = event.getError();
                        log(`‚ùå Ad request error: ${error.getMessage()}`, 'error');
                        log(`Error code: ${error.getErrorCode()}`, 'error');
                        log(`Error type: ${error.getType()}`, 'error');
                        
                        if (error.getErrorCode() === 1009) {
                            log('‚ö†Ô∏è Error 1009 = VAST response is empty (no fill)', 'warn');
                        }
                        
                        cleanup();
                    }
                );

                const adsRequest = new google.ima.AdsRequest();
                adsRequest.adTagUrl = url;
                adsRequest.linearAdSlotWidth = 640;
                adsRequest.linearAdSlotHeight = 480;

                log('Requesting ad from IMA...', 'info');
                adsLoader.requestAds(adsRequest);

                function cleanup() {
                    if (adContainer && adContainer.parentNode) {
                        adContainer.parentNode.removeChild(adContainer);
                    }
                    if (video && video.parentNode) {
                        video.parentNode.removeChild(video);
                    }
                }

            } catch (error) {
                log(`‚ùå Exception: ${error.message}`, 'error');
            }
        }

        // Auto-test on load
        window.addEventListener('load', () => {
            setTimeout(testVast, 500);
        });
    </script>
</body>
</html>

